<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg" style="background-color:#8e44ad">
            <div class="container-fluid">
                <a class="navbar-brand text-white fw-bold" href="#">MyDuka</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    style="border-color:white"><span class="navbar-toggler-icon"
                        style="filter:brightness(0) invert(1)"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav position-absolute top-50 start-50 translate-middle">
                        <li class="nav-item"><a class="nav-link text-white" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="products.html">Products</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="sales.html">Sales</a></li>
                        <li class="nav-item"><a class="nav-link active text-white" href="dashboard.html">Dashboard</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item" v-if="!loggedIn"><a class="nav-link text-white"
                                href="register.html">Register</a></li>
                        <li class="nav-item" v-if="!loggedIn"><a class="nav-link text-white" href="login.html">Login</a>
                        </li>
                        <li class="nav-item" v-if="loggedIn">
                            <button @click="logout" class="nav-link text-white">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="container mt-5">
            <div class="bg-primary text-white p-4 rounded mb-4">
                <h2>Dashboard Overview</h2>
                <p>Your central hub for monitoring business performance.</p>
            </div>

            <div class="text-center my-5" v-show="loading">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                <p>Loading charts...</p>
            </div>

            <!-- Always render canvas -->
            <div>
                <canvas id="bar-chart" width="800" height="450"></canvas>
                <br />
                <canvas id="line-chart" width="800" height="450"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-white text-center py-3 mt-5" style="background-color: #8e44ad;">
            <div class="container">
                <small>&copy; 2025 MyDuka. All rights reserved.</small>
            </div>
        </footer>
    </div>

    <!-- JS libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.16/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>

    <!-- Vue App Script -->
    <script>
        const app = new Vue({
            el: "#app",
            data: {
                loading: true,
                products_name: [],
                products_sales: [],
                products_colour: [],
                dates: [],
                sales: [],
                loggedIn: false
            },
            methods: {
                logout() {
                    localStorage.removeItem("token");
                    window.location.href = "login.html";
                },

                fetchDashboard() {
                    const token = localStorage.getItem("token");
                    if (!token) {
                        window.location.href = "login.html";
                        return;
                    }
                    this.loggedIn = true;

                    axios.get("http://127.0.0.1:5000/api/dashboard", {
                        headers: { Authorization: "Bearer " + token }
                    })
                        .then(res => {
                            const profitData = res.data.profit_per_product;
                            const salesData = res.data.sales_per_day;

                            this.products_name = profitData.products_name;
                            this.products_sales = profitData.products_sales;
                            this.products_colour = profitData.products_colour;

                            this.dates = salesData.dates;
                            this.sales = salesData.sales;

                            this.loading = false;

                            this.loadBarchart();
                            this.loadLinechart();
                        })
                        .catch(err => {
                            console.error("Error loading dashboard data:", err);
                            alert("Unauthorized or failed to load dashboard data.");
                            window.location.href = "login.html";
                        });
                },

                loadBarchart() {
                    new Chart(document.getElementById("bar-chart"), {
                        type: 'bar',
                        data: {
                            labels: this.products_name,
                            datasets: [{
                                label: "Profit per Product",
                                backgroundColor: this.products_colour,
                                data: this.products_sales
                            }]
                        },
                        options: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Profit per Product'
                            }
                        }
                    });
                },

                loadLinechart() {
                    new Chart(document.getElementById("line-chart"), {
                        type: 'line',
                        data: {
                            labels: this.dates,
                            datasets: [{
                                data: this.sales,
                                label: "Sales per Day",
                                borderColor: "#3e95cd",
                                fill: false
                            }]
                        },
                        options: {
                            title: {
                                display: true,
                                text: 'Sales per Day'
                            }
                        }
                    });
                }
            },
            mounted() {
                this.fetchDashboard();
            }
        });
    </script>

</body>

</html>